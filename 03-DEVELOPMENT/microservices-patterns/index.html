<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="https://nitinkc.github.io/BitVelocity-Docs/03-DEVELOPMENT/microservices-patterns/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Microservices Patterns - BitVelocity Wiki</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../css/brands.min.css" rel="stylesheet">
        <link href="../../css/solid.min.css" rel="stylesheet">
        <link href="../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">BitVelocity Wiki</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href="../.." class="nav-link">Home</a>
                            </li>
                            <li class="nav-item">
                                <a href="../../INDEX_DOMAIN_DESIGNS/" class="nav-link">Index Domain Designs</a>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Overview</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../00-OVERVIEW/project-charter/" class="dropdown-item">Project Charter</a>
</li>
                                    
<li>
    <a href="../../00-OVERVIEW/stakeholder-guide/" class="dropdown-item">Stakeholder Guide</a>
</li>
                                    
<li>
    <a href="../../00-OVERVIEW/" class="dropdown-item">README</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Architecture</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../01-ARCHITECTURE/data-architecture/" class="dropdown-item">Data Architecture</a>
</li>
                                    
<li>
    <a href="../../01-ARCHITECTURE/system-overview/" class="dropdown-item">System Overview</a>
</li>
                                    
<li>
    <a href="../../01-ARCHITECTURE/CROSS_COST_OPTIMIZATION/" class="dropdown-item">Cross-Cost Optimization</a>
</li>
                                    
<li>
    <a href="../../01-ARCHITECTURE/CROSS_DATA_PLATFORM_AND_ANALYTICS/" class="dropdown-item">Cross-Data Platform and Analytics</a>
</li>
                                    
<li>
    <a href="../../01-ARCHITECTURE/CROSS_EVENT_CONTRACTS_AND_VERSIONING/" class="dropdown-item">Cross-Event Contracts and Versioning</a>
</li>
                                    
<li>
    <a href="../../01-ARCHITECTURE/CROSS_EXECUTION_BACKLOG_AND_SPRINT_PLAN/" class="dropdown-item">Cross-Execution Backlog and Sprint Plan</a>
</li>
                                    
<li>
    <a href="../../01-ARCHITECTURE/CROSS_OBSERVABILITY_AND_TESTING/" class="dropdown-item">Cross-Observability and Testing</a>
</li>
                                    
<li>
    <a href="../../01-ARCHITECTURE/CROSS_REPLAY_DR_DRILLS/" class="dropdown-item">Cross-Replay DR Drills</a>
</li>
                                    
<li>
    <a href="../../01-ARCHITECTURE/domains/" class="dropdown-item">Domains</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Infrastructure</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../02-INFRASTRUCTURE/cloud-strategy/" class="dropdown-item">Cloud Strategy</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Development</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="./" class="dropdown-item active" aria-current="page">Microservices Patterns</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Project Management</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../05-PROJECT-MANAGEMENT/budget-planning/" class="dropdown-item">Budget Planning</a>
</li>
                                    
<li>
    <a href="../../05-PROJECT-MANAGEMENT/sprint-1-daily-execution-plan/" class="dropdown-item">Sprint 1 Daily Execution Plan</a>
</li>
                                    
<li>
    <a href="../../05-PROJECT-MANAGEMENT/sprint-planning/" class="dropdown-item">Sprint Planning</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">ADRs</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../adr/ADR-TEMPLATE/" class="dropdown-item">Template</a>
</li>
                                    
<li>
    <a href="../../adr/GUIDE_ADR_STARTER_PACK/" class="dropdown-item">Starter Pack</a>
</li>
                                    
<li>
    <a href="../../adr/ADR-001-multi-repo-vs-monorepo/" class="dropdown-item">ADR-001 Multi-repo vs Monorepo</a>
</li>
                                    
<li>
    <a href="../../adr/ADR-001_1-github%20Packages-vs-JitPack/" class="dropdown-item">ADR-001 Github Packages vs JitPack</a>
</li>
                                    
<li>
    <a href="../../adr/ADR-002-event-vs-cdc-strategy/" class="dropdown-item">ADR-002 Event vs CDC Strategy</a>
</li>
                                    
<li>
    <a href="../../adr/ADR-003-protocol-introduction-order/" class="dropdown-item">ADR-003 Protocol Introduction Order</a>
</li>
                                    
<li>
    <a href="../../adr/ADR-004-oltp-cdc-olap-architecture/" class="dropdown-item">ADR-004 OLTP CDC OLAP Architecture</a>
</li>
                                    
<li>
    <a href="../../adr/ADR-005-security-layering/" class="dropdown-item">ADR-005 Security Layering</a>
</li>
                                    
<li>
    <a href="../../adr/ADR-006-retry-backoff-policies/" class="dropdown-item">ADR-006 Retry Backoff Policies</a>
</li>
                                    
<li>
    <a href="../../adr/ADR-007-observability-baseline/" class="dropdown-item">ADR-007 Observability Baseline</a>
</li>
                                    
<li>
    <a href="../../adr/ADR-008-pulumi-cloud-provider-abstraction/" class="dropdown-item">ADR-008 Pulumi Cloud Provider Abstraction</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Event Contracts</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../event-contracts/GUIDE_EVENT_CONTRACTS_USAGE/" class="dropdown-item">Guide</a>
</li>
                                    
<li>
    <a href="../../event-contracts/CHANGELOG.md" class="dropdown-item">Changelog</a>
</li>
                                    
<li>
    <a href="../../event-contracts/" class="dropdown-item">Readme</a>
</li>
                                    
<li>
    <a href="../../event-contracts/chat/README.md" class="dropdown-item">Chat</a>
</li>
                                    
<li>
    <a href="../../event-contracts/ecommerce/README.md" class="dropdown-item">Ecommerce</a>
</li>
                                    
<li>
    <a href="../../event-contracts/iot/README.md" class="dropdown-item">IoT</a>
</li>
                                    
<li>
    <a href="../../event-contracts/ml/README.md" class="dropdown-item">ML</a>
</li>
                                    
<li>
    <a href="../../event-contracts/schema/README.md" class="dropdown-item">Schema</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../../02-INFRASTRUCTURE/cloud-strategy/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../../05-PROJECT-MANAGEMENT/budget-planning/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#microservices-patterns-implementation-guide" class="nav-link">Microservices Patterns &amp; Implementation Guide</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#purpose" class="nav-link">Purpose</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#pattern-introduction-strategy" class="nav-link">Pattern Introduction Strategy</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#core-microservices-patterns" class="nav-link">Core Microservices Patterns</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#implementation-roadmap" class="nav-link">Implementation Roadmap</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#testing-strategy" class="nav-link">Testing Strategy</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#monitoring-and-observability" class="nav-link">Monitoring and Observability</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="microservices-patterns-implementation-guide">Microservices Patterns &amp; Implementation Guide</h1>
<h2 id="purpose">Purpose</h2>
<p>This document provides comprehensive guidance on microservices patterns, their implementation in the BitVelocity platform, and the sequence for introducing complexity during the learning process.</p>
<h2 id="pattern-introduction-strategy">Pattern Introduction Strategy</h2>
<h3 id="learning-sequence">Learning Sequence</h3>
<ol>
<li><strong>Foundation Patterns</strong> (Weeks 1-4): Basic CRUD, Authentication, Events</li>
<li><strong>Communication Patterns</strong> (Weeks 5-8): API Gateway, Service Discovery, Circuit Breaker</li>
<li><strong>Data Patterns</strong> (Weeks 9-12): CQRS, Event Sourcing, Saga</li>
<li><strong>Advanced Integration</strong> (Weeks 13-16): BFF, Anti-Corruption Layer, Strangler Fig</li>
<li><strong>Operational Patterns</strong> (Weeks 17-20): Bulkhead, Timeout, Retry, Rate Limiting</li>
</ol>
<h2 id="core-microservices-patterns">Core Microservices Patterns</h2>
<h3 id="1-service-decomposition-patterns">1. Service Decomposition Patterns</h3>
<h4 id="database-per-service">Database per Service</h4>
<p><strong>Intent</strong>: Each microservice owns its data and database schema.</p>
<pre><code class="language-java">// Order Service - owns order data
@Entity
@Table(name = &quot;orders&quot;)
public class Order {
    @Id
    private UUID orderId;
    private UUID customerId; // Reference, not FK
    private OrderStatus status;
    private BigDecimal totalAmount;

    // Audit fields
    private Instant createdAt;
    private String createdBy;
}

// Customer Service - owns customer data  
@Entity
@Table(name = &quot;customers&quot;)
public class Customer {
    @Id
    private UUID customerId;
    private String email;
    private String name;
    private CustomerStatus status;
}
</code></pre>
<p><strong>Implementation Strategy</strong>:
- Start with logical separation in same database
- Migrate to physical separation as services stabilize
- Use shared libraries for common patterns</p>
<h4 id="shared-libraries-pattern">Shared Libraries Pattern</h4>
<p><strong>Intent</strong>: Share common code while maintaining service autonomy.</p>
<pre><code class="language-java">// Shared event library
@AllArgsConstructor
@Getter
public abstract class DomainEvent {
    private final UUID eventId = UUID.randomUUID();
    private final Instant timestamp = Instant.now();
    private final String eventType;
    private final UUID aggregateId;
    private final String correlationId;
    private final Map&lt;String, String&gt; metadata;
}

// Usage in Order Service
public class OrderCreatedEvent extends DomainEvent {
    private final UUID customerId;
    private final BigDecimal amount;
    private final List&lt;OrderItem&gt; items;

    public OrderCreatedEvent(UUID orderId, UUID customerId, BigDecimal amount, List&lt;OrderItem&gt; items) {
        super(&quot;OrderCreated&quot;, orderId, MDC.get(&quot;correlationId&quot;), getEventMetadata());
        this.customerId = customerId;
        this.amount = amount;
        this.items = items;
    }
}
</code></pre>
<h3 id="2-communication-patterns">2. Communication Patterns</h3>
<h4 id="api-gateway-pattern">API Gateway Pattern</h4>
<p><strong>Intent</strong>: Single entry point for all client requests with cross-cutting concerns.</p>
<pre><code class="language-java">@RestController
@RequestMapping(&quot;/api/gateway&quot;)
public class ApiGatewayController {

    @Autowired
    private ServiceRegistry serviceRegistry;

    @Autowired
    private LoadBalancer loadBalancer;

    @PostMapping(&quot;/orders&quot;)
    public ResponseEntity&lt;OrderResponse&gt; createOrder(
            @RequestBody CreateOrderRequest request,
            @RequestHeader(&quot;Authorization&quot;) String authToken) {

        // Authentication &amp; Authorization
        var user = authService.validateToken(authToken);

        // Rate limiting
        rateLimiter.checkLimit(user.getId());

        // Request routing
        var orderService = serviceRegistry.getService(&quot;order-service&quot;);
        var endpoint = loadBalancer.selectEndpoint(orderService);

        // Request transformation
        var internalRequest = requestTransformer.transform(request, user);

        // Circuit breaker protection
        return circuitBreaker.execute(() -&gt; 
            orderServiceClient.createOrder(endpoint, internalRequest)
        );
    }
}
</code></pre>
<h4 id="service-discovery-pattern">Service Discovery Pattern</h4>
<p><strong>Intent</strong>: Services register themselves and discover other services dynamically.</p>
<pre><code class="language-java">@Component
public class ServiceRegistry {

    private final Map&lt;String, List&lt;ServiceInstance&gt;&gt; services = new ConcurrentHashMap&lt;&gt;();

    @EventListener
    public void handleServiceRegistration(ServiceRegistrationEvent event) {
        services.computeIfAbsent(event.getServiceName(), k -&gt; new ArrayList&lt;&gt;())
                .add(event.getServiceInstance());

        log.info(&quot;Service registered: {} at {}&quot;, 
                event.getServiceName(), 
                event.getServiceInstance().getEndpoint());
    }

    public List&lt;ServiceInstance&gt; getHealthyInstances(String serviceName) {
        return services.getOrDefault(serviceName, Collections.emptyList())
                .stream()
                .filter(ServiceInstance::isHealthy)
                .collect(Collectors.toList());
    }
}

// Service registration on startup
@Component
public class ServiceRegistrar implements ApplicationListener&lt;ContextRefreshedEvent&gt; {

    @Override
    public void onApplicationEvent(ContextRefreshedEvent event) {
        var instance = ServiceInstance.builder()
                .serviceId(UUID.randomUUID())
                .serviceName(applicationProperties.getServiceName())
                .endpoint(buildEndpoint())
                .metadata(getServiceMetadata())
                .healthCheckUrl(getHealthCheckUrl())
                .build();

        serviceRegistry.register(instance);
    }
}
</code></pre>
<h4 id="circuit-breaker-pattern">Circuit Breaker Pattern</h4>
<p><strong>Intent</strong>: Prevent cascading failures by failing fast when downstream services are unhealthy.</p>
<pre><code class="language-java">@Component
public class CircuitBreaker {

    private final Map&lt;String, CircuitBreakerState&gt; circuitStates = new ConcurrentHashMap&lt;&gt;();

    public &lt;T&gt; T execute(String circuitName, Supplier&lt;T&gt; operation, Supplier&lt;T&gt; fallback) {
        var state = circuitStates.computeIfAbsent(circuitName, k -&gt; new CircuitBreakerState());

        if (state.isOpen()) {
            if (state.shouldAttemptReset()) {
                state.halfOpen();
            } else {
                return fallback.get();
            }
        }

        try {
            var result = operation.get();
            state.recordSuccess();
            return result;
        } catch (Exception e) {
            state.recordFailure();
            if (state.shouldTrip()) {
                state.open();
            }
            return fallback.get();
        }
    }
}

// Usage
@Service
public class OrderService {

    public Order getOrderDetails(UUID orderId) {
        return circuitBreaker.execute(
            &quot;customer-service&quot;,
            () -&gt; customerServiceClient.getCustomer(order.getCustomerId()),
            () -&gt; CustomerSummary.unavailable(order.getCustomerId())
        );
    }
}
</code></pre>
<h3 id="3-data-management-patterns">3. Data Management Patterns</h3>
<h4 id="command-query-responsibility-segregation-cqrs">Command Query Responsibility Segregation (CQRS)</h4>
<p><strong>Intent</strong>: Separate read and write models for better scalability and maintainability.</p>
<pre><code class="language-java">// Command side - optimized for writes
@Entity
@Table(name = &quot;orders&quot;)
public class OrderAggregate {
    @Id
    private UUID orderId;
    private UUID customerId;
    private OrderStatus status;
    private List&lt;OrderItem&gt; items;

    public void addItem(OrderItem item) {
        validateItem(item);
        this.items.add(item);
        applyEvent(new OrderItemAddedEvent(orderId, item));
    }

    public void confirm() {
        if (status != OrderStatus.PENDING) {
            throw new InvalidOrderStateException(&quot;Order must be pending to confirm&quot;);
        }
        this.status = OrderStatus.CONFIRMED;
        applyEvent(new OrderConfirmedEvent(orderId, Instant.now()));
    }
}

// Query side - optimized for reads
@Document(collection = &quot;order_views&quot;)
public class OrderView {
    @Id
    private UUID orderId;
    private String customerName;
    private String customerEmail;
    private BigDecimal totalAmount;
    private String status;
    private List&lt;OrderItemView&gt; items;
    private Instant createdAt;
    private Instant lastUpdated;
}

// Projection handler
@EventListener
@Component
public class OrderViewProjectionHandler {

    @Autowired
    private OrderViewRepository orderViewRepository;

    @KafkaListener(topics = &quot;order-events&quot;)
    public void handleOrderEvent(DomainEvent event) {
        switch (event.getEventType()) {
            case &quot;OrderCreated&quot; -&gt; handleOrderCreated((OrderCreatedEvent) event);
            case &quot;OrderConfirmed&quot; -&gt; handleOrderConfirmed((OrderConfirmedEvent) event);
            case &quot;OrderItemAdded&quot; -&gt; handleOrderItemAdded((OrderItemAddedEvent) event);
        }
    }

    private void handleOrderCreated(OrderCreatedEvent event) {
        var orderView = OrderView.builder()
                .orderId(event.getAggregateId())
                .customerId(event.getCustomerId())
                .totalAmount(event.getTotalAmount())
                .status(&quot;PENDING&quot;)
                .createdAt(event.getTimestamp())
                .build();

        orderViewRepository.save(orderView);
    }
}
</code></pre>
<h4 id="event-sourcing-pattern">Event Sourcing Pattern</h4>
<p><strong>Intent</strong>: Store domain events as the primary source of truth.</p>
<pre><code class="language-java">@Entity
@Table(name = &quot;event_store&quot;)
public class EventStore {
    @Id
    private UUID eventId;
    private UUID aggregateId;
    private String aggregateType;
    private String eventType;
    private String eventData;
    private Integer version;
    private Instant timestamp;
    private String metadata;

    // Optimistic locking
    @Version
    private Long lockVersion;
}

@Repository
public class EventStoreRepository {

    public void saveEvents(UUID aggregateId, List&lt;DomainEvent&gt; events, Integer expectedVersion) {
        var currentVersion = getLatestVersion(aggregateId);

        if (!currentVersion.equals(expectedVersion)) {
            throw new ConcurrencyException(&quot;Aggregate has been modified&quot;);
        }

        for (int i = 0; i &lt; events.size(); i++) {
            var event = events.get(i);
            var eventStoreEntry = EventStore.builder()
                    .eventId(event.getEventId())
                    .aggregateId(aggregateId)
                    .aggregateType(getAggregateType(aggregateId))
                    .eventType(event.getEventType())
                    .eventData(jsonMapper.writeValueAsString(event))
                    .version(expectedVersion + i + 1)
                    .timestamp(event.getTimestamp())
                    .build();

            eventStoreJpaRepository.save(eventStoreEntry);
        }
    }

    public List&lt;DomainEvent&gt; getEvents(UUID aggregateId) {
        return eventStoreJpaRepository.findByAggregateIdOrderByVersion(aggregateId)
                .stream()
                .map(this::deserializeEvent)
                .collect(Collectors.toList());
    }
}

// Aggregate reconstruction
@Component
public class AggregateRepository&lt;T extends AggregateRoot&gt; {

    public T getById(UUID aggregateId, Class&lt;T&gt; aggregateClass) {
        var events = eventStoreRepository.getEvents(aggregateId);
        var aggregate = createEmptyAggregate(aggregateClass);

        events.forEach(aggregate::applyEvent);
        aggregate.markEventsAsCommitted();

        return aggregate;
    }

    public void save(T aggregate) {
        var uncommittedEvents = aggregate.getUncommittedEvents();
        eventStoreRepository.saveEvents(
            aggregate.getId(), 
            uncommittedEvents, 
            aggregate.getVersion()
        );

        // Publish events to message bus
        eventPublisher.publish(uncommittedEvents);

        aggregate.markEventsAsCommitted();
    }
}
</code></pre>
<h4 id="saga-pattern-orchestration">Saga Pattern (Orchestration)</h4>
<p><strong>Intent</strong>: Manage distributed transactions across multiple services.</p>
<pre><code class="language-java">@Component
public class OrderSaga {

    private enum SagaState {
        STARTED, PAYMENT_PENDING, INVENTORY_RESERVED, 
        COMPLETED, COMPENSATING, FAILED
    }

    @Entity
    @Table(name = &quot;saga_instances&quot;)
    public static class SagaInstance {
        @Id
        private UUID sagaId;
        private UUID orderId;
        private SagaState state;
        private Map&lt;String, Object&gt; sagaData;
        private Instant createdAt;
        private Instant updatedAt;
    }

    @SagaOrchestrationStart
    public void handleOrderCreated(OrderCreatedEvent event) {
        var sagaInstance = new SagaInstance(UUID.randomUUID(), event.getAggregateId());
        sagaInstance.setState(SagaState.STARTED);
        sagaRepository.save(sagaInstance);

        // Step 1: Reserve inventory
        commandGateway.send(new ReserveInventoryCommand(
            event.getAggregateId(),
            event.getItems()
        ));
    }

    @SagaOrchestrationHandler
    public void handleInventoryReserved(InventoryReservedEvent event) {
        var saga = sagaRepository.findByOrderId(event.getOrderId());
        saga.setState(SagaState.INVENTORY_RESERVED);
        sagaRepository.save(saga);

        // Step 2: Process payment
        commandGateway.send(new ProcessPaymentCommand(
            event.getOrderId(),
            saga.getSagaData().get(&quot;paymentAmount&quot;)
        ));
    }

    @SagaOrchestrationHandler
    public void handlePaymentProcessed(PaymentProcessedEvent event) {
        var saga = sagaRepository.findByOrderId(event.getOrderId());
        saga.setState(SagaState.COMPLETED);
        sagaRepository.save(saga);

        // Step 3: Confirm order
        commandGateway.send(new ConfirmOrderCommand(event.getOrderId()));
    }

    // Compensation handlers
    @SagaOrchestrationHandler
    public void handleInventoryReservationFailed(InventoryReservationFailedEvent event) {
        var saga = sagaRepository.findByOrderId(event.getOrderId());
        saga.setState(SagaState.FAILED);
        sagaRepository.save(saga);

        commandGateway.send(new CancelOrderCommand(event.getOrderId()));
    }

    @SagaOrchestrationHandler
    public void handlePaymentFailed(PaymentFailedEvent event) {
        var saga = sagaRepository.findByOrderId(event.getOrderId());
        saga.setState(SagaState.COMPENSATING);
        sagaRepository.save(saga);

        // Compensate: Release inventory
        commandGateway.send(new ReleaseInventoryCommand(
            event.getOrderId(),
            saga.getSagaData().get(&quot;reservedItems&quot;)
        ));
    }
}
</code></pre>
<h3 id="4-integration-patterns">4. Integration Patterns</h3>
<h4 id="backend-for-frontend-bff">Backend for Frontend (BFF)</h4>
<p><strong>Intent</strong>: Create service layers tailored to specific frontend needs.</p>
<pre><code class="language-java">// Mobile BFF
@RestController
@RequestMapping(&quot;/mobile/api&quot;)
public class MobileBffController {

    @GetMapping(&quot;/dashboard&quot;)
    public MobileDashboardResponse getDashboard(@AuthenticationPrincipal User user) {
        // Optimized for mobile - minimal data
        var orders = orderService.getRecentOrders(user.getId(), 5);
        var recommendations = recommendationService.getTopRecommendations(user.getId(), 3);

        return MobileDashboardResponse.builder()
                .recentOrders(orders.stream()
                    .map(this::toMobileOrderSummary)
                    .collect(Collectors.toList()))
                .recommendations(recommendations)
                .build();
    }

    private MobileOrderSummary toMobileOrderSummary(Order order) {
        return MobileOrderSummary.builder()
                .orderId(order.getId())
                .status(order.getStatus())
                .totalAmount(order.getTotalAmount())
                .itemCount(order.getItems().size())
                .build();
    }
}

// Web BFF
@RestController
@RequestMapping(&quot;/web/api&quot;)
public class WebBffController {

    @GetMapping(&quot;/dashboard&quot;)
    public WebDashboardResponse getDashboard(@AuthenticationPrincipal User user) {
        // Rich data for web interface
        var orders = orderService.getRecentOrdersWithDetails(user.getId(), 10);
        var analytics = analyticsService.getUserAnalytics(user.getId());
        var recommendations = recommendationService.getPersonalizedRecommendations(user.getId(), 10);

        return WebDashboardResponse.builder()
                .orders(orders)
                .analytics(analytics)
                .recommendations(recommendations)
                .build();
    }
}
</code></pre>
<h4 id="anti-corruption-layer-acl">Anti-Corruption Layer (ACL)</h4>
<p><strong>Intent</strong>: Protect domain model from external system dependencies.</p>
<pre><code class="language-java">// Legacy payment gateway adapter
@Component
public class LegacyPaymentGatewayAdapter implements PaymentGateway {

    @Autowired
    private LegacyPaymentClient legacyClient;

    @Override
    public PaymentResult processPayment(PaymentRequest request) {
        // Translate domain model to legacy format
        var legacyRequest = LegacyPaymentRequest.builder()
                .amount(request.getAmount().multiply(BigDecimal.valueOf(100))) // Convert to cents
                .currency(request.getCurrency().getCurrencyCode())
                .cardNumber(request.getCardDetails().getNumber())
                .expiryMonth(String.format(&quot;%02d&quot;, request.getCardDetails().getExpiryMonth()))
                .expiryYear(String.valueOf(request.getCardDetails().getExpiryYear()))
                .build();

        try {
            var legacyResponse = legacyClient.chargeCard(legacyRequest);

            // Translate response back to domain model
            return PaymentResult.builder()
                    .paymentId(UUID.fromString(legacyResponse.getTransactionId()))
                    .status(mapLegacyStatus(legacyResponse.getStatus()))
                    .amount(legacyResponse.getChargedAmount().divide(BigDecimal.valueOf(100)))
                    .processedAt(Instant.parse(legacyResponse.getTimestamp()))
                    .build();

        } catch (LegacyPaymentException e) {
            throw new PaymentProcessingException(&quot;Payment failed&quot;, e);
        }
    }

    private PaymentStatus mapLegacyStatus(String legacyStatus) {
        return switch (legacyStatus) {
            case &quot;SUCCESS&quot; -&gt; PaymentStatus.COMPLETED;
            case &quot;PENDING&quot; -&gt; PaymentStatus.PROCESSING;
            case &quot;DECLINED&quot; -&gt; PaymentStatus.DECLINED;
            case &quot;ERROR&quot; -&gt; PaymentStatus.FAILED;
            default -&gt; throw new IllegalArgumentException(&quot;Unknown legacy status: &quot; + legacyStatus);
        };
    }
}
</code></pre>
<h4 id="strangler-fig-pattern">Strangler Fig Pattern</h4>
<p><strong>Intent</strong>: Gradually replace legacy systems by intercepting and redirecting calls.</p>
<pre><code class="language-java">@Component
public class OrderServiceStranglerFig {

    @Autowired
    private LegacyOrderService legacyOrderService;

    @Autowired
    private ModernOrderService modernOrderService;

    @Autowired
    private FeatureToggleService featureToggleService;

    public Order getOrder(UUID orderId) {
        // Determine which implementation to use
        if (shouldUseLegacyService(orderId)) {
            var legacyOrder = legacyOrderService.getOrder(orderId.toString());
            return adaptLegacyOrder(legacyOrder);
        } else {
            return modernOrderService.getOrder(orderId);
        }
    }

    public Order createOrder(CreateOrderRequest request) {
        // New orders always use modern service
        var order = modernOrderService.createOrder(request);

        // Optionally sync to legacy system for compatibility
        if (featureToggleService.isEnabled(&quot;sync-to-legacy&quot;)) {
            legacyOrderService.syncOrder(adaptModernOrder(order));
        }

        return order;
    }

    private boolean shouldUseLegacyService(UUID orderId) {
        // Check if order exists in modern system
        if (modernOrderService.exists(orderId)) {
            return false;
        }

        // Check feature toggle for gradual migration
        var migrationPercentage = featureToggleService.getPercentage(&quot;modern-order-service&quot;);
        var hash = orderId.hashCode() % 100;

        return hash &gt;= migrationPercentage;
    }
}
</code></pre>
<h3 id="5-resilience-patterns">5. Resilience Patterns</h3>
<h4 id="bulkhead-pattern">Bulkhead Pattern</h4>
<p><strong>Intent</strong>: Isolate resources to prevent cascading failures.</p>
<pre><code class="language-java">@Configuration
public class BulkheadConfiguration {

    @Bean
    @Qualifier(&quot;orderProcessing&quot;)
    public Executor orderProcessingExecutor() {
        return new ThreadPoolTaskExecutor() {{
            setCorePoolSize(5);
            setMaxPoolSize(10);
            setQueueCapacity(25);
            setThreadNamePrefix(&quot;order-processing-&quot;);
            setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy());
        }};
    }

    @Bean
    @Qualifier(&quot;notifications&quot;)
    public Executor notificationExecutor() {
        return new ThreadPoolTaskExecutor() {{
            setCorePoolSize(2);
            setMaxPoolSize(5);
            setQueueCapacity(50);
            setThreadNamePrefix(&quot;notifications-&quot;);
            setRejectedExecutionHandler(new ThreadPoolExecutor.DiscardOldestPolicy());
        }};
    }

    @Bean
    @Qualifier(&quot;analytics&quot;)
    public Executor analyticsExecutor() {
        return new ThreadPoolTaskExecutor() {{
            setCorePoolSize(1);
            setMaxPoolSize(3);
            setQueueCapacity(100);
            setThreadNamePrefix(&quot;analytics-&quot;);
            setRejectedExecutionHandler(new ThreadPoolExecutor.DiscardPolicy());
        }};
    }
}

@Service
public class OrderService {

    @Async(&quot;orderProcessing&quot;)
    public CompletableFuture&lt;Order&gt; processOrder(CreateOrderRequest request) {
        // Critical order processing in dedicated thread pool
        return CompletableFuture.completedFuture(createOrder(request));
    }

    @Async(&quot;notifications&quot;)
    public void sendOrderNotification(Order order) {
        // Non-critical notifications in separate thread pool
        notificationService.sendOrderConfirmation(order);
    }

    @Async(&quot;analytics&quot;)
    public void recordOrderAnalytics(Order order) {
        // Analytics processing in lowest priority thread pool
        analyticsService.recordOrderEvent(order);
    }
}
</code></pre>
<h4 id="timeout-pattern">Timeout Pattern</h4>
<p><strong>Intent</strong>: Prevent resource exhaustion by setting maximum wait times.</p>
<pre><code class="language-java">@Component
public class TimeoutConfiguration {

    @Bean
    public RestTemplate restTemplate() {
        var factory = new HttpComponentsClientHttpRequestFactory();
        factory.setConnectTimeout(5000);     // 5 seconds
        factory.setReadTimeout(10000);       // 10 seconds

        return new RestTemplate(factory);
    }

    @Bean
    public RedisTemplate&lt;String, Object&gt; redisTemplate() {
        var template = new RedisTemplate&lt;String, Object&gt;();
        template.setConnectionFactory(jedisConnectionFactory());

        // Set command timeout
        var jedisConfig = new JedisPoolConfig();
        jedisConfig.setMaxWaitMillis(2000);  // 2 seconds

        return template;
    }
}

// Service with timeout handling
@Service
public class ExternalApiService {

    @Autowired
    private RestTemplate restTemplate;

    @Retryable(value = {TimeoutException.class}, maxAttempts = 3)
    public ApiResponse callExternalApi(ApiRequest request) {
        try {
            return restTemplate.postForObject(&quot;/api/external&quot;, request, ApiResponse.class);
        } catch (ResourceAccessException e) {
            if (e.getCause() instanceof SocketTimeoutException) {
                throw new TimeoutException(&quot;External API call timed out&quot;, e);
            }
            throw e;
        }
    }

    @Recover
    public ApiResponse recoverFromTimeout(TimeoutException ex, ApiRequest request) {
        log.warn(&quot;External API call failed after retries, using fallback response&quot;);
        return ApiResponse.fallback();
    }
}
</code></pre>
<h4 id="retry-pattern-with-backoff">Retry Pattern with Backoff</h4>
<p><strong>Intent</strong>: Handle transient failures with intelligent retry strategies.</p>
<pre><code class="language-java">@Component
public class RetryConfiguration {

    // Linear backoff
    @Bean
    @Qualifier(&quot;linearRetry&quot;)
    public RetryTemplate linearRetryTemplate() {
        return RetryTemplate.builder()
            .maxAttempts(3)
            .fixedBackoff(1000) // 1 second between retries
            .retryOn(TransientException.class)
            .build();
    }

    // Exponential backoff
    @Bean
    @Qualifier(&quot;exponentialRetry&quot;)
    public RetryTemplate exponentialRetryTemplate() {
        return RetryTemplate.builder()
            .maxAttempts(5)
            .exponentialBackoff(1000, 2, 10000) // 1s, 2s, 4s, 8s, 10s
            .retryOn(TransientException.class)
            .build();
    }

    // Exponential backoff with jitter
    @Bean
    @Qualifier(&quot;jitterRetry&quot;)
    public RetryTemplate jitterRetryTemplate() {
        var backoffPolicy = new ExponentialBackOffPolicy();
        backoffPolicy.setInitialInterval(1000);
        backoffPolicy.setMultiplier(2.0);
        backoffPolicy.setMaxInterval(10000);

        var retryPolicy = new SimpleRetryPolicy();
        retryPolicy.setMaxAttempts(5);

        var template = new RetryTemplate();
        template.setBackOffPolicy(backoffPolicy);
        template.setRetryPolicy(retryPolicy);

        // Add jitter
        template.setBackOffPolicy(new ExponentialRandomBackOffPolicy() {{
            setInitialInterval(1000);
            setMultiplier(2.0);
            setMaxInterval(10000);
        }});

        return template;
    }
}

@Service
public class PaymentService {

    @Autowired
    @Qualifier(&quot;jitterRetry&quot;)
    private RetryTemplate retryTemplate;

    public PaymentResult processPayment(PaymentRequest request) {
        return retryTemplate.execute(context -&gt; {
            log.info(&quot;Processing payment, attempt {}&quot;, context.getRetryCount() + 1);

            try {
                return paymentGateway.processPayment(request);
            } catch (PaymentGatewayException e) {
                if (e.isRetryable()) {
                    throw new TransientException(&quot;Payment gateway temporarily unavailable&quot;, e);
                } else {
                    throw new PermanentException(&quot;Payment failed permanently&quot;, e);
                }
            }
        });
    }
}
</code></pre>
<h2 id="implementation-roadmap">Implementation Roadmap</h2>
<h3 id="week-1-2-foundation">Week 1-2: Foundation</h3>
<ul>
<li>Service decomposition (logical)</li>
<li>Basic API Gateway</li>
<li>Shared libraries setup</li>
<li>Simple retry patterns</li>
</ul>
<h3 id="week-3-4-communication">Week 3-4: Communication</h3>
<ul>
<li>Service discovery</li>
<li>Circuit breaker</li>
<li>Load balancing</li>
<li>Health checks</li>
</ul>
<h3 id="week-5-6-data-patterns">Week 5-6: Data Patterns</h3>
<ul>
<li>CQRS implementation</li>
<li>Event store setup</li>
<li>Basic projections</li>
<li>Command/query separation</li>
</ul>
<h3 id="week-7-8-advanced-data">Week 7-8: Advanced Data</h3>
<ul>
<li>Event sourcing</li>
<li>Saga orchestration</li>
<li>Compensation patterns</li>
<li>Event replay</li>
</ul>
<h3 id="week-9-10-integration">Week 9-10: Integration</h3>
<ul>
<li>BFF implementation</li>
<li>Anti-corruption layers</li>
<li>Legacy system integration</li>
<li>API versioning</li>
</ul>
<h3 id="week-11-12-resilience">Week 11-12: Resilience</h3>
<ul>
<li>Bulkhead pattern</li>
<li>Timeout configuration</li>
<li>Advanced retry strategies</li>
<li>Failure injection testing</li>
</ul>
<h2 id="testing-strategy">Testing Strategy</h2>
<h3 id="pattern-specific-testing">Pattern-Specific Testing</h3>
<pre><code class="language-java">// Test CQRS command/query separation
@Test
public void testCqrsSeparation() {
    // Given
    var command = new CreateOrderCommand(customerId, items);

    // When
    var orderId = commandHandler.handle(command);

    // Then - verify command side
    var aggregate = aggregateRepository.load(orderId);
    assertThat(aggregate.getStatus()).isEqualTo(OrderStatus.PENDING);

    // And verify query side (eventually consistent)
    await().atMost(5, SECONDS).until(() -&gt; {
        var orderView = queryService.getOrderView(orderId);
        return orderView.getStatus().equals(&quot;PENDING&quot;);
    });
}

// Test circuit breaker
@Test
public void testCircuitBreakerTrip() {
    // Given - service is failing
    when(externalService.call()).thenThrow(new ServiceException());

    // When - multiple calls
    for (int i = 0; i &lt; 5; i++) {
        try {
            serviceWithCircuitBreaker.callExternal();
        } catch (Exception e) {
            // Expected
        }
    }

    // Then - circuit breaker should be open
    assertThat(circuitBreaker.getState()).isEqualTo(CircuitBreakerState.OPEN);

    // And subsequent calls should fail fast
    var start = System.currentTimeMillis();
    try {
        serviceWithCircuitBreaker.callExternal();
    } catch (Exception e) {
        var duration = System.currentTimeMillis() - start;
        assertThat(duration).isLessThan(100); // Failed fast
    }
}
</code></pre>
<h2 id="monitoring-and-observability">Monitoring and Observability</h2>
<h3 id="pattern-specific-metrics">Pattern-Specific Metrics</h3>
<pre><code class="language-java">@Component
public class MicroservicesMetrics {

    private final MeterRegistry meterRegistry;

    // Circuit breaker metrics
    public void recordCircuitBreakerState(String circuitName, String state) {
        Gauge.builder(&quot;circuit_breaker.state&quot;)
            .tag(&quot;circuit&quot;, circuitName)
            .tag(&quot;state&quot;, state)
            .register(meterRegistry, this, value -&gt; state.equals(&quot;OPEN&quot;) ? 1 : 0);
    }

    // Saga metrics
    public void recordSagaCompletion(String sagaType, String outcome, Duration duration) {
        Timer.builder(&quot;saga.duration&quot;)
            .tag(&quot;saga_type&quot;, sagaType)
            .tag(&quot;outcome&quot;, outcome)
            .register(meterRegistry)
            .record(duration);
    }

    // CQRS metrics
    public void recordCommandProcessing(String commandType, Duration duration) {
        Timer.builder(&quot;command.processing.duration&quot;)
            .tag(&quot;command_type&quot;, commandType)
            .register(meterRegistry)
            .record(duration);
    }

    public void recordQueryExecution(String queryType, Duration duration) {
        Timer.builder(&quot;query.execution.duration&quot;)
            .tag(&quot;query_type&quot;, queryType)
            .register(meterRegistry)
            .record(duration);
    }
}
</code></pre>
<hr />
<p>This comprehensive guide provides a structured approach to implementing microservices patterns in the BitVelocity platform, ensuring gradual complexity introduction while maintaining production-ready standards.</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
